<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Voie ‚ûú Leviers | Tableau interactif</title>
  <style>
    /* NOUVELLE PALETTE DE COULEURS TH√âMATIQUE POUR LE MONDE FERROVIAIRE */
    :root{
      --bg:#111827;           /* Gris anthracite, pour un fond solide et moderne */
      --bg-gradient: radial-gradient(100% 50% at 70% 5%, rgba(4,103,163,.15) 0%, transparent 60%), var(--bg);
      --card:#1f2937;         /* Bleu-gris sombre */
      --card-gradient: linear-gradient(180deg, rgba(255,255,255,.02), transparent 48%), var(--card);
      --text:#e5e7eb;         /* Blanc cass√© */
      --muted:#9ca3af;        /* Gris pour le texte secondaire */
      --border:rgba(255,255,255,.08);
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(59,130,246,.35);
      --accent:#3b82f6;       /* Bleu vif, inspir√© des couleurs SNCF */
      --warn:#fcd34d;         /* Jaune de s√©curit√© */
      --danger:#ef4444;       /* Rouge de signalisation */
      --radius:18px;
      
      /* Couleurs pour les pastilles de voie (th√®me sombre) */
      --tag-group-1: #2563eb; /* Bleu fonc√© */
      --tag-group-2: #16a34a; /* Vert fonc√© */
      --tag-group-3: #d97706; /* Orange fonc√© */
      --tag-group-4: #dc2626; /* Rouge fonc√© */
      
      /* Couleurs pour la carte de r√©sultat (th√®me sombre) */
      --result-group-1-bg: #1a243d;
      --result-group-2-bg: #212c45;
      --result-group-3-bg: #2a3550;
      --result-group-4-bg: #313d5c;
    }
    
    /* VARIABLES DE COULEURS POUR LE TH√àME CLAIR */
    body.theme-light{
      --bg:#f8fafc;
      --bg-gradient: none;
      --card:#ffffff;
      --card-gradient: linear-gradient(180deg, rgba(0,0,0,.02), transparent 48%), var(--card);
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(0,0,0,.08);
      --shadow: 0 20px 60px rgba(0,0,0,.08);
      --focus: 0 0 0 3px rgba(59,130,246,.35);
      --accent:#2563eb;
      --warn:#d97706;
      --danger:#dc2626;

      /* Couleurs pour les pastilles de voie (th√®me clair) */
      --tag-group-1: #2563eb;
      --tag-group-2: #16a34a;
      --tag-group-3: #d97706;
      --tag-group-4: #dc2626;
      
      /* Couleurs pour la carte de r√©sultat (th√®me clair) */
      --result-group-1-bg: #e0f2fe;
      --result-group-2-bg: #d1fae5;
      --result-group-3-bg: #fef3c7;
      --result-group-4-bg: #fee2e2;
    }
    /* Styles sp√©cifiques pour le th√®me clair */
    body.theme-light .tag.history-tag {
        background-color: #f1f5f9;
        color: #475569;
        border-color: rgba(0,0,0,0.1);
    }
    body.theme-light .kbd{
        background:#e2e8f0;
        border:1px solid rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: var(--bg-gradient);
      color:var(--text); 
      line-height:1.45;
      transition: background-color .3s ease, color .3s ease;
    }
    .wrap{max-width:980px; margin:40px auto; padding:0 16px}
    header{display:flex; gap:14px; align-items:center; margin-bottom:22px; position:relative;}
    header .logo{width:44px; height:44px; border-radius:12px; display:grid; place-items:center; background:var(--accent); box-shadow: var(--shadow)}
    header h1{font-size:clamp(22px,3.5vw,36px); margin:0; letter-spacing:.2px}
    header p{margin:2px 0 0; color:var(--muted)}

    /* SVG du logo de train */
    .logo-svg{width: 28px; height: 28px; fill: #fff;}
    body.theme-light .logo-svg{fill: #fff;}

    /* Styles pour le bouton de th√®me */
    #themeToggleBtn{
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      display: grid;
      place-items: center;
      font-size: 22px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
    }

    /* Styles de base pour la carte principale */
    .card{background:var(--card-gradient);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px}
    
    /* Styles pour la carte de r√©sultats, avec les 4 nouvelles couleurs */
    #resultCard {
      background: var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      transition: background-color .3s ease, border-color .3s ease;
    }
    #resultCard.group-1-bg { background-color: var(--result-group-1-bg); border-color: rgba(255,255,255,.1); }
    #resultCard.group-2-bg { background-color: var(--result-group-2-bg); border-color: rgba(255,255,255,.12); }
    #resultCard.group-3-bg { background-color: var(--result-group-3-bg); border-color: rgba(255,255,255,.14); }
    #resultCard.group-4-bg { background-color: var(--result-group-4-bg); border-color: rgba(255,255,255,.16); }
    body.theme-light #resultCard.group-1-bg { border-color: rgba(0,0,0,.1); }
    body.theme-light #resultCard.group-2-bg { border-color: rgba(0,0,0,.12); }
    body.theme-light #resultCard.group-3-bg { border-color: rgba(0,0,0,.14); }
    body.theme-light #resultCard.group-4-bg { border-color: rgba(0,0,0,.16); }

    .grid{display:grid; grid-template-columns: 1fr; gap:14px}
    @media(min-width:760px){ .grid{ grid-template-columns: 1.5fr 1fr } }

    .input{display:flex; gap:10px; align-items:center}
    .input input{flex:1; padding:14px 16px; border-radius:14px; border:1px solid var(--border); background:var(--bg); color:var(--text); outline:none}
    .input input:focus{box-shadow: var(--focus); border-color: var(--accent)}
    .btn{
        padding:12px 16px; 
        border-radius:12px; 
        border:1px solid var(--border); 
        background:var(--bg); 
        color:var(--text); 
        cursor:pointer;
        display: flex; /* Permet d'aligner l'ic√¥ne et le texte */
        align-items: center;
        justify-content: center;
        gap: 8px; /* Espace entre l'ic√¥ne et le texte */
    }
    .btn:hover{border-color:var(--accent)}
    body.theme-light .btn{ background:var(--card); }
    .btn-icon{
        width: 18px;
        height: 18px;
        stroke: currentColor;
    }


    .tags{display:flex; flex-wrap:wrap; gap:8px}
    /* Conteneur principal pour les rang√©es de voies */
    #voiesList {
        display: flex;
        flex-direction: column; /* Organise les groupes en colonne (donc en rang√©es) */
        gap: 16px; /* Espace vertical entre les rang√©es */
    }
    /* Chaque groupe de voies est maintenant une rang√©e */
    .tag-group-wrapper {
        display: flex;
        flex-direction: row; /* Organise les pastilles en ligne */
        flex-wrap: wrap; /* Permet aux pastilles de passer √† la ligne si n√©cessaire */
        gap: 8px; /* Espace horizontal entre les pastilles */
    }
    /* Couleurs pour les pastilles de voies disponibles */
    .tag{
        padding:8px 10px; 
        border-radius:999px; 
        border:1px dashed var(--border); 
        font-size:14px;
        transition: color 0.2s ease, border-color 0.2s ease;
        position: relative; /* N√©cessaire pour la croix */
        cursor: pointer;
        background-color: transparent;
    }
    .tag:hover {
        border-color: var(--accent);
    }

    .tag.group-1-color { color: var(--tag-group-1); }
    .tag.group-2-color { color: var(--tag-group-2); }
    .tag.group-3-color { color: var(--tag-group-3); }
    .tag.group-4-color { color: var(--tag-group-4); }

    /* Style pour les pastilles non-accessibles */
    .tag.unavailable-voie {
        opacity: 0.5;
        cursor: not-allowed;
        color: var(--muted) !important;
    }
    .tag.unavailable-voie::after {
        content: '\2715'; /* Caract√®re "heavy multiplication x" (croix) */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
        color: var(--danger); /* Rouge pour la croix */
    }
    /* Styles pour l'historique de recherche */
    #historyZone {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--border);
    }
    .tag.history-tag {
        background-color: rgba(255,255,255,0.05);
        color: var(--muted);
        border: 1px solid var(--border);
    }
    body.theme-light .tag.history-tag {
        background-color: #f1f5f9;
        color: #475569;
        border-color: rgba(0,0,0,0.1);
    }


    .columns{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:600px){ .columns{grid-template-columns:1fr 1fr} }
    .col{padding:16px; border-radius:14px; background:var(--bg); border:1px solid var(--border)}
    .col h3{margin:6px 0 12px; font-size:18px}
    .list{display:flex; flex-wrap:wrap; gap:10px}
    .pill{
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:999px; 
      padding:10px 12px;
    }
    .pill.tirer { color: var(--accent); }
    .pill.pousser { color: var(--warn); }


    .muted{color:var(--muted)}
    .ok{color:var(--accent)}
    .warn{color:var(--warn)}
    .hint{font-size:13px; color:var(--muted)}
    .sep{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); margin:14px 0}
    body.theme-light .sep{ background:linear-gradient(90deg, transparent, rgba(0,0,0,.08), transparent); }

    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 8px; border-bottom:1px solid var(--border)}
    th{color:var(--muted); text-align:left; font-weight:600; font-size:12px; letter-spacing:.08em; text-transform:uppercase}

    .empty{padding:24px; border:1px dashed var(--border); border-radius:14px; text-align:center; color:var(--muted)}
    .footer{margin-top:24px; font-size:12px; color:var(--muted)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:var(--bg); border:1px solid var(--border); padding:2px 6px; border-radius:8px}

    /* Styles sp√©cifiques pour la section des anecdotes */
    #anecdote-section h3 {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #anecdote-section p {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.6;
    }
    #anecdote-section .anecdote-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
    }
    .anecdote-btn {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
    }
    .anecdote-btn:hover {
        border-color: var(--accent);
    }
    
    /* NOUVEAUX STYLES pour les tableaux */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table th, .data-table td {
        padding: 8px 4px;
        border: none;
        vertical-align: top;
    }
    .data-table th {
        font-size: 11px;
        color: var(--muted);
        text-align: left;
        font-weight: 600;
        letter-spacing: .08em;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border);
    }
    .data-table td input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .data-table td input:focus {
        box-shadow: var(--focus);
        border-color: var(--accent);
    }
    
    /* Nouveau style pour les messages d'erreur des champs de saisie */
    .input-error {
        color: var(--danger);
        font-size: 12px;
        margin-top: 4px;
        text-align: right;
        min-height: 1em;
    }

    /* NOUVEAUX STYLES pour la section Prochaines Manoeuvres */
    #manoeuvres-section .manoeuvre-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }
    #manoeuvres-section .manoeuvre-actions .btn {
        flex-grow: 1;
        min-width: 120px;
    }
    /* Styles pour les nouveaux boutons par ligne */
    .row-actions {
        display: flex;
        gap: 4px;
        justify-content: flex-end;
    }
    .btn-icon-only {
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: background-color .2s ease, border-color .2s ease;
    }
    
    /* Styles sp√©cifiques pour les boutons color√©s */
    .btn-icon-only.btn-clear {
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: var(--danger);
    }
    .btn-icon-only.btn-clear:hover {
        background-color: rgba(239, 68, 68, 0.2);
    }
    .btn-icon-only.btn-switch {
        background-color: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.5);
        color: var(--accent);
    }
    .btn-icon-only.btn-switch:hover {
        background-color: rgba(59, 130, 246, 0.2);
    }

    .btn-icon-only .btn-icon {
        width: 16px;
        height: 16px;
    }


    /* Styles pour la validation de man≈ìuvre */
    .manoeuvre-result {
      padding: 12px;
      border-radius: 10px;
      margin-top: 12px;
      font-weight: 600;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .manoeuvre-result.success {
      background-color: rgba(22, 163, 74, 0.2);
      color: var(--tag-group-2);
      border: 1px solid var(--tag-group-2);
    }
    .manoeuvre-result.error {
      background-color: rgba(220, 38, 38, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .manoeuvre-result.info {
      background-color: rgba(59, 130, 246, 0.1);
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .manoeuvre-result .lever-action {
        color: var(--warn);
        font-weight: bold;
    }
    .manoeuvre-result ul {
        list-style-type: none;
        padding-left: 0;
        margin-top: 8px;
        font-weight: normal;
    }
    .manoeuvre-result ul li {
        margin-bottom: 4px;
        padding-left: 1.5em;
        text-indent: -1.5em;
    }
    .error {
        padding: 24px;
        border: 1px dashed var(--danger);
        border-radius: 14px;
        text-align: center;
        color: var(--danger);
        background-color: rgba(239, 68, 68, 0.1);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <!-- Ic√¥ne de train SVG -->
        <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C8.5,2,6,2.5,6,6v9.5c0,1.38,1.12,2.5,2.5,2.5S11,16.88,11,15.5V10h2v5.5c0,1.38,1.12,2.5,2.5,2.5s2.5-1.12,2.5-2.5V6C18,2.5,15.5,2,12,2z M12,4c1.65,0,3,0.5,3,2s-1.35,2-3,2s-3-0.5-3-2S10.35,4,12,4z M8,15.5c0,0.83-0.67,1.5-1.5,1.5S5,16.33,5,15.5V12h3V15.5z M17.5,17c-0.83,0-1.5-0.67-1.5-1.5V12h3v3.5C19,16.33,18.33,17,17.5,17z"/></svg>
      </div>
      <div>
        <h1>Voie ‚ûú Leviers</h1>
        <p class="muted">Tableau de man≈ìuvre ferroviaire interactif</p>
      </div>
      <!-- Nouveau bouton pour basculer de th√®me -->
      <button id="themeToggleBtn" title="Basculer de th√®me">
        <span id="themeToggleIcon">‚òÄÔ∏è</span>
      </button>
    </header>

    <section class="card grid">
      <div>
        <div class="input">
          <input id="voieInput" type="text" placeholder="Saisir un num√©ro de voie‚Ä¶ (ex: 41 ou 53)" />
          <button class="btn" id="btnSearch">Rechercher</button>
        </div>
        <div class="hint" style="margin-top:8px">Astuce : appuie sur <span class="kbd">Entr√©e</span> pour lancer la recherche.</div>
        <div class="sep"></div>
        <div id="resultZone">
          <div class="empty">Aucun r√©sultat pour le moment. Saisis un num√©ro de voie ci‚Äëdessus.</div>
        </div>
        <!-- Nouvelle section pour l'historique -->
        <div id="historyZone" style="display: none;">
            <p class="hint" style="margin-bottom: 8px;">Historique des 3 derni√®res recherches :</p>
            <div id="historyList" class="tags"></div>
        </div>
      </div>
      <aside>
        <div class="col">
          <h3>Voies disponibles</h3>
          <div id="voiesList"></div>
        </div>
        
        <!-- BLOC MIS √Ä JOUR : Prochaines Manoeuvres -->
        <div class="col" style="margin-top:12px" id="manoeuvres-section">
            <h3>Prochaines Manoeuvres</h3>
            <table class="data-table" id="manoeuvres-table">
                <thead>
                    <tr>
                        <th>Origine</th>
                        <th>Destination</th>
                        <th>Actions</th> <!-- Nouvelle colonne pour les boutons -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                          <input type="text" class="manoeuvre-origine-input" placeholder="Origine" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                          <input type="text" class="manoeuvre-destination-input" placeholder="Destination" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon-only btn-clear" title="Effacer la ligne">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                </button>
                                <button class="btn-icon-only btn-switch" title="Inverser les voies">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21l-5-5-5 5M7 3l5 5 5-5"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                          <input type="text" class="manoeuvre-origine-input" placeholder="Origine" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                          <input type="text" class="manoeuvre-destination-input" placeholder="Destination" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon-only btn-clear" title="Effacer la ligne">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                </button>
                                <button class="btn-icon-only btn-switch" title="Inverser les voies">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21l-5-5-5 5M7 3l5 5 5-5"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                          <input type="text" class="manoeuvre-origine-input" placeholder="Origine" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                          <input type="text" class="manoeuvre-destination-input" placeholder="Destination" oninput="validateInput(this)" />
                          <div class="input-error"></div>
                        </td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon-only btn-clear" title="Effacer la ligne">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                </button>
                                <button class="btn-icon-only btn-switch" title="Inverser les voies">
                                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21l-5-5-5 5M7 3l5 5 5-5"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="manoeuvre-actions">
                <!-- Bouton "Valider" -->
                <button class="btn" id="btn-manoeuvre-validate">Valider la man≈ìuvre</button>
            </div>
            <!-- Nouvel emplacement pour le r√©sultat de la validation -->
            <div id="manoeuvre-validation-result" class="manoeuvre-result" style="display: none;"></div>
        </div>
        
        <div class="col" style="margin-top:12px" id="anecdote-section">
            <h3>Le saviez-vous ?</h3>
            <p id="anecdote-text" class="muted"></p>
            <div class="anecdote-actions">
                <button class="anecdote-btn" id="anecdote-next-btn">Autre anecdote</button>
            </div>
        </div>
      </aside>
    </section>

    <p class="footer">Donn√©es transcrites d'apr√®s une source papier. En cas d'erreur, modifiez la constante `DATA` dans le script et rechargez la page.</p>
  </div>

  <script>
    // --- Donn√©es (transcrites depuis la photo, corrections appliqu√©es) ---
    // Chaque voie ‚Üí { tirer: [...], pousser: [...] }
    const DATA = {
        "21": { tirer: [2,18,26,30,32], pousser: [] },
        "23": { tirer: [2,18,26,30], pousser: [32] },
        "25": { tirer: [2,18,26,31], pousser: [30] },
        "27": { tirer: [2,18,26], pousser: [30,31] },
        "29": { tirer: [2,18,27,29], pousser: [26] },
        "31": { tirer: [2,18,27], pousser: [26,29] },
        "33": { tirer: [2,18,28], pousser: [26,27] },
        "35": { tirer: [2,18], pousser: [26,27,28] },
        "37": { tirer: [2,19,23,25], pousser: [18] },
        "39": { tirer: [2,19,23], pousser: [18,25] },
        "41": { tirer: [2,19,24], pousser: [18,23] },
        "43": { tirer: [2,19], pousser: [18,23,24] },
        "45": { tirer: [2,20,22], pousser: [18,19] },
        "47": { tirer: [2,20], pousser: [18,19,22] },
        "49": { tirer: [2,21], pousser: [18,19,20] },
        "51": { tirer: [2], pousser: [18,19,20,21] },
        "53": { tirer: [3,11,15,17], pousser: [2] },
        "55": { tirer: [3,11,15], pousser: [2,17] },
        "57": { tirer: [3,11,16], pousser: [2,15] },
        "59": { tirer: [3], pousser: [2,15,16] },
        "61": { tirer: [3,12,14], pousser: [2,11] },
        "63": { tirer: [3,12], pousser: [2,11,14] },
        "65": { tirer: [3,13], pousser: [2,11,12] },
        "67": { tirer: [3], pousser: [2,11,12,13] },
        "69": { tirer: [4,8,10], pousser: [2,3] },
        "71": { tirer: [4,8], pousser: [2,3,10] },
        "73": { tirer: [4,9], pousser: [2,3,8] },
        "75": { tirer: [4], pousser: [2,3,8,9] },
        "77": { tirer: [5,7], pousser: [2,3,4] },
        "79": { tirer: [5], pousser: [2,3,4,7] },
        "81": { tirer: [6], pousser: [2,3,4,5] },
        "83": { tirer: [], pousser: [2,3,4,5,6] }
    };
    
    // Voies √† marquer comme non accessibles
    const UNAVAILABLE_VOIES = ["59", "63", "79"];

    // Tableau d'anecdotes sur la SNCF
    const SNCF_ANECDOTES = [
      "Le viaduc de Garabit, construit par Gustave Eiffel et achev√© en 1884, √©tait le plus haut du monde √† son √©poque.",
      "Le TGV a battu le record du monde de vitesse sur rail en 2007, atteignant 574,8 km/h.",
      "La SNCF g√®re l'un des r√©seaux ferr√©s les plus denses d'Europe, avec environ 29 000 km de lignes en exploitation.",
      "Le r√©seau ferr√© fran√ßais est en forme d'√©toile, avec Paris en son centre, une structure h√©rit√©e du 19√®me si√®cle.",
      "Le nom 'TGV' est une marque d√©pos√©e, mais il est souvent utilis√© comme un nom commun pour d√©signer un train √† grande vitesse en France."
    ];

    // --- DOM Elements ---
    const voiesList = document.getElementById('voiesList');
    const resultZone = document.getElementById('resultZone');
    const voieInput  = document.getElementById('voieInput');
    const btnSearch = document.getElementById('btnSearch');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeToggleIcon = document.getElementById('themeToggleIcon');
    const historyZone = document.getElementById('historyZone');
    const historyList = document.getElementById('historyList');
    const anecdoteText = document.getElementById('anecdote-text');
    const anecdoteNextBtn = document.getElementById('anecdote-next-btn');
    const manoeuvresTable = document.getElementById('manoeuvres-table');
    const btnManoeuvreValidate = document.getElementById('btn-manoeuvre-validate');
    const manoeuvreValidationResult = document.getElementById('manoeuvre-validation-result');

    let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
    const HISTORY_MAX_ITEMS = 3; // Limite de l'historique

    // --- Fonctions de gestion du th√®me ---
    function applyTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('theme-light');
        themeToggleIcon.textContent = 'üåô';
      } else {
        document.body.classList.remove('theme-light');
        themeToggleIcon.textContent = '‚òÄÔ∏è';
      }
    }
    
    // --- Fonctions pour les anecdotes ---
    function displayRandomAnecdote() {
        const randomIndex = Math.floor(Math.random() * SNCF_ANECDOTES.length);
        anecdoteText.textContent = SNCF_ANECDOTES[randomIndex];
    }

    // --- Fonctions de gestion de l'historique ---
    function updateHistory(voie) {
        // Enl√®ve la voie si elle existe d√©j√† pour la remettre au d√©but
        searchHistory = searchHistory.filter(v => v !== voie);
        // Ajoute la voie en d√©but de tableau
        searchHistory.unshift(voie);
        // Limite la taille de l'historique
        if (searchHistory.length > HISTORY_MAX_ITEMS) {
            searchHistory.pop();
        }
        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        renderHistory();
    }

    function renderHistory() {
        historyList.innerHTML = '';
        if (searchHistory.length > 0) {
            historyZone.style.display = 'block';
            searchHistory.forEach(v => {
                const b = document.createElement('button');
                b.className = 'tag history-tag';
                b.textContent = v;
                b.onclick = () => { voieInput.value = v; search(); };
                historyList.appendChild(b);
            });
        } else {
            historyZone.style.display = 'none';
        }
    }
    
    // --- Fonctions principales ---

    /**
     * D√©termine le groupe d'une voie pour la coloration et le regroupement en rang√©es.
     * @param {string} voie - Le num√©ro de la voie.
     * @returns {number} Le num√©ro du groupe (1-4).
     */
    function getVoieGroup(voie) {
        const v = parseInt(voie);
        if (v >= 21 && v <= 35) return 1;
        if (v >= 37 && v <= 51) return 2;
        if (v >= 53 && v <= 67) return 3;
        if (v >= 69 && v <= 83) return 4;
        return 1; // Groupe par d√©faut pour toute voie impr√©vue
    }

    /**
     * Affiche la liste des voies disponibles.
     */
    function renderVoies() {
        voiesList.innerHTML = '';
        const allVoies = Object.keys(DATA);
        const groups = {};

        allVoies.forEach(voie => {
            const groupNum = getVoieGroup(voie);
            if (!groups[groupNum]) {
                groups[groupNum] = [];
            }
            groups[groupNum].push(voie);
        });

        Object.keys(groups).sort().forEach(groupNum => {
            const wrapper = document.createElement('div');
            wrapper.className = 'tag-group-wrapper';
            
            groups[groupNum].forEach(voie => {
                const isUnavailable = UNAVAILABLE_VOIES.includes(voie);
                const tag = document.createElement('button');
                tag.className = `tag group-${groupNum}-color`;
                tag.textContent = voie;
                tag.dataset.voie = voie;

                if (isUnavailable) {
                    tag.classList.add('unavailable-voie');
                    tag.disabled = true;
                    tag.title = "Voie non accessible";
                } else {
                    tag.onclick = () => {
                        voieInput.value = voie;
                        search();
                    };
                }
                wrapper.appendChild(tag);
            });
            voiesList.appendChild(wrapper);
        });
    }

    /**
     * Lance une recherche et affiche les r√©sultats.
     */
    function search() {
        const voie = voieInput.value.trim();
        if (!voie) {
            resultZone.innerHTML = `<div class="empty">Veuillez saisir un num√©ro de voie.</div>`;
            return;
        }

        const voieNum = parseInt(voie);
        if (isNaN(voieNum) || voieNum % 2 === 0) {
            resultZone.innerHTML = `<div class="error">Erreur : Seuls les num√©ros de voie <strong>impairs</strong> sont accept√©s.</div>`;
            return;
        }

        if (UNAVAILABLE_VOIES.includes(voie)) {
            resultZone.innerHTML = `<div class="error">La voie <strong>${voie}</strong> n'est pas accessible.</div>`;
            return;
        }

        const result = DATA[voie];
        if (!result) {
            resultZone.innerHTML = `<div class="error">La voie <strong>${voie}</strong> n'existe pas dans la table.</div>`;
            return;
        }
        
        updateHistory(voie);

        const group = getVoieGroup(voie);
        
        resultZone.innerHTML = `
            <div id="resultCard" class="group-${group}-bg">
                <h3>R√©sultats pour la voie <span class="ok">${voie}</span></h3>
                <div class="columns">
                    <div class="col">
                        <h3>√Ä TIRER</h3>
                        <div class="list">
                            ${result.tirer.length > 0 ? result.tirer.map(l => `<div class="pill tirer">${l}</div>`).join('') : '<span class="muted">Aucun</span>'}
                        </div>
                    </div>
                    <div class="col">
                        <h3>√Ä POUSSER</h3>
                        <div class="list">
                            ${result.pousser.length > 0 ? result.pousser.map(l => `<div class="pill pousser">${l}</div>`).join('') : '<span class="muted">Aucun</span>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Valide en temps r√©el l'entr√©e d'une voie.
     * @param {HTMLInputElement} inputElement - Le champ de saisie.
     */
    function validateInput(inputElement) {
        const errorElement = inputElement.nextElementSibling;
        const value = inputElement.value.trim();

        if (value === '') {
            inputElement.style.borderColor = '';
            if(errorElement) errorElement.textContent = '';
            return;
        }
        
        const voieNum = parseInt(value);
        if (isNaN(voieNum) || voieNum % 2 === 0) {
            inputElement.style.borderColor = 'var(--danger)';
            if(errorElement) errorElement.textContent = "Impair attendu";
        } else if (!DATA[value]) {
            inputElement.style.borderColor = 'var(--danger)';
            if(errorElement) errorElement.textContent = 'Voie invalide';
        } else {
            inputElement.style.borderColor = '';
            if(errorElement) errorElement.textContent = '';
        }
    }
    
    // --- FONCTIONS POUR LA SECTION "PROCHAINES MANOEUVRES" ---
    const ordrePhysique = [2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17, 18,19,20,21,22,23,24,25,26,27,28,29,30,31,32]; 

    function calculateManeuverActions(from, to) { 
        const start = DATA[String(from)]; 
        const end = DATA[String(to)]; 

        if (!start || !end) { 
            console.error("Voie inconnue !"); 
            return []; 
        } 

        const actions = []; 
        const startTirer = new Set(start.tirer);
        
        end.tirer.forEach(l => { 
            if (!startTirer.has(l)) { 
                actions.push({ levier: l, action: "tirer" }); 
            } 
        }); 

        end.pousser.forEach(l => { 
            if (startTirer.has(l)) { 
                actions.push({ levier: l, action: "pousser" }); 
            } 
        }); 

        const pos = new Map(ordrePhysique.map((L, i) => [L, i])); 
        actions.sort((a, b) => (pos.get(a.levier) || 999) - (pos.get(b.levier) || 999)); 

        return actions.map((a, i) => ({ rang: i + 1, ...a })); 
    }

    function validateManoeuvre() {
        const rows = manoeuvresTable.querySelectorAll('tbody tr');
        let allActions = [];
        let hasError = false;
        let isFirstManeuver = true;
        let finalHtml = '';

        rows.forEach((row, index) => {
            if (hasError) return;

            const origineInput = row.querySelector('.manoeuvre-origine-input');
            const destinationInput = row.querySelector('.manoeuvre-destination-input');
            const origine = origineInput.value.trim();
            const destination = destinationInput.value.trim();

            if (!origine || !destination) {
                if(origine || destination) { // Only one is filled
                    finalHtml = `Erreur sur la ligne ${index + 1} : Veuillez remplir les deux champs (Origine et Destination).`;
                    manoeuvreValidationResult.className = 'manoeuvre-result error';
                    hasError = true;
                }
                return; // Ignore empty or incomplete rows
            }

            if (!DATA[origine] || !DATA[destination]) {
                finalHtml = `Erreur sur la ligne ${index + 1} : Une des voies est invalide.`;
                manoeuvreValidationResult.className = 'manoeuvre-result error';
                hasError = true;
                return;
            }
            
            const actions = calculateManeuverActions(origine, destination);
            if (actions.length > 0) {
                if (isFirstManeuver) {
                    finalHtml += `<strong>R√©sum√© des man≈ìuvres :</strong>`;
                    isFirstManeuver = false;
                }
                finalHtml += `<ul><strong>De ${origine} √† ${destination}:</strong>` +
                    actions.map(action => `<li><span class="lever-action">${action.action.toUpperCase()}</span> le levier <strong>${action.levier}</strong></li>`).join('') +
                    `</ul>`;
            }
        });

        manoeuvreValidationResult.style.display = 'block';

        if (hasError) {
            manoeuvreValidationResult.innerHTML = finalHtml;
        } else if (finalHtml === '') {
            manoeuvreValidationResult.className = 'manoeuvre-result info';
            manoeuvreValidationResult.innerHTML = 'Aucune action requise pour les man≈ìuvres sp√©cifi√©es.';
        } else {
            manoeuvreValidationResult.className = 'manoeuvre-result success';
            manoeuvreValidationResult.innerHTML = finalHtml;
        }
    }


    // --- Initialisation de la page ---
    document.addEventListener('DOMContentLoaded', () => {
        // Chargement du th√®me
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);

        // Listeners
        themeToggleBtn.addEventListener('click', () => {
            const isLight = document.body.classList.contains('theme-light');
            const newTheme = isLight ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });
        
        btnSearch.addEventListener('click', search);
        voieInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                search();
            }
        });
        anecdoteNextBtn.addEventListener('click', displayRandomAnecdote);
        btnManoeuvreValidate.addEventListener('click', validateManoeuvre);

        // Event delegation for maneuver table buttons
        manoeuvresTable.addEventListener('click', (e) => {
            const button = e.target.closest('.btn-icon-only');
            if (!button) return;

            const row = button.closest('tr');
            const origineInput = row.querySelector('.manoeuvre-origine-input');
            const destinationInput = row.querySelector('.manoeuvre-destination-input');

            if (button.classList.contains('btn-clear')) {
                origineInput.value = '';
                destinationInput.value = '';
                validateInput(origineInput);
                validateInput(destinationInput);
            } else if (button.classList.contains('btn-switch')) {
                const temp = origineInput.value;
                origineInput.value = destinationInput.value;
                destinationInput.value = temp;
                validateInput(origineInput);
                validateInput(destinationInput);
            }
        });

        // Rendu initial
        renderVoies();
        renderHistory();
        displayRandomAnecdote();
    });

  </script>
</body>
</html>
